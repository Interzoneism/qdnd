# QDND Copilot Instructions

**Godot 4.6 C# tactical RPG with BG3-faithful combat rules.** Read [AGENTS.md](../AGENTS.md) and [CODING_STANDARDS.md](../CODING_STANDARDS.md) before any change; they are the authority. Do not commit or push — the user does that.

---

## Architecture Overview

```
Combat/
├── Services/       ← All services registered via ICombatContext (constructor injection)
├── Actions/        ← ActionRegistry: single source for all action definitions
├── Targeting/      ← 3-layer system: Modes (logic) → TargetingSystem → Visuals (rendering)
├── States/         ← CombatStateMachine + CombatSubstate
├── Rules/          ← D&D 5e rules (ConditionEffects.cs is the sole conditions authority)
├── Passives/       ← PassiveRegistry → BoostApplicator pipeline
└── UI/             ← Godot nodes; subscribe to signals from model layer

Data/               ← BG3 LSX data parsed at startup via ActionRegistryInitializer
Combat/Arena/       ← CombatArena.tscn is the primary scene entry point
```

**Data pipeline**: `BG3_Data/` → `Parsers` → `Registries` → Runtime systems — all wired by `RegistryInitializer.Bootstrap()` in `CombatArena._Ready()`.

**CombatArena** is the composition root (~2.5k lines). ~85k lines of C# across ~300 files, 18 subsystems.

**Service wiring**: All services register via `ICombatContext.RegisterService<T>()` and resolve via `GetService<T>()`. Never pull services from anywhere else; do not use `GetNode<T>()` for services.

**ActionRegistry** is initialized in `CombatArena._Ready()` via `ActionRegistryInitializer.Initialize(...)` and fed from `BG3_Data/` LSX files through `BG3SpellParser` → `BG3ActionConverter` → `ActionDefinition`.

**Stats authority**: `CharacterSheet` / `CharacterResolver` only. Ability modifier = `Math.Floor((score - 10) / 2.0)`. Save DC = `8 + proficiency + abilityModifier`. Never hardcode DC or modifier values.

---

## Key Systems Quick Reference

| System | Entry Point | Key Files |
|---|---|---|
| Actions | `ActionRegistry`, `EffectPipeline` | `Combat/Actions/` (28 effect types) |
| AI | `AIDecisionPipeline` | `Combat/AI/` (`BG3ArchetypeProfile` scoring) |
| Environment | `SurfaceManager`, `LOSService`, `HeightService` | `Combat/Environment/` |
| Movement | `MovementService`, `TacticalPathfinder` | `Combat/Movement/` |
| Reactions | `ReactionSystem`, `BG3ReactionIntegration` | `Combat/Reactions/` (13 BG3 reactions) |
| Rules | `RulesEngine`, `DamagePipeline` | `Combat/Rules/` (boosts, conditions, functors) |
| States | `CombatStateMachine` | `Combat/States/` (clean FSM) |
| Statuses | `StatusSystem` (`StatusManager`), `ConcentrationSystem` | `Combat/Statuses/` |
| Targeting | `TargetingSystem` (3-layer) | `Combat/Targeting/` (12 modes) |
| UI | `HudController` (new), `CombatHUD` (legacy) | `Combat/UI/` |
| VFX | `VfxPlaybackService`, `PresentationRequestBus` | `Combat/VFX/` |

---

## Communication Patterns

| Context | Mechanism | Example |
|---|---|---|
| Service ↔ Service | `event Action<T>` | `public event Action<Combatant, int>? OnDamageDealt;` |
| UI model → UI panel | Godot `[Signal]` | `[Signal] delegate void TurnEndedEventHandler()` |
| Camera / VFX / SFX | `PresentationRequestBus` | Fired from `CombatPresentationService` |

**Never use** `event EventHandler<T>` — use `event Action<T>` throughout.

---

## Targeting System (3-layer contract)

1. **Modes** (`Combat/Targeting/Modes/`) — pure C# logic, write into `TargetingPreviewData`, no nodes/meshes.
2. **TargetingSystem** — orchestrator; fires `OnPreviewUpdated`; owns phase lifecycle.
3. **Visuals** (`Combat/Targeting/Visuals/`) — reads `TargetingPreviewData`, pool-based rendering via `TargetingNodePool<T>`.

Style constants live in `TargetingStyleTokens` — no per-skill magic numbers in renderers.

---

## Namespaces & File Rules

- All code: `QDND.*` matching directory path (e.g. `Combat/Actions/` → `QDND.Combat.Actions`).
- One primary class per file; filename matches class name.
- Godot node classes must be `public partial class`.
- `.cs.uid` files are auto-generated by Godot — never create/delete manually.

---

## Build Gates (run before declaring done)

```bash
./scripts/ci-build.sh                  # dotnet build
./scripts/ci-test.sh                   # xUnit + parity validation gate
./scripts/ci-godot-log-check.sh        # headless ~60-frame smoke test; fails on ERROR/SCRIPT ERROR
```

---

## Testing Workflows

```bash
# xUnit unit/integration tests (no Godot runtime)
dotnet test Tests/QDND.Tests.csproj

# Fast headless auto-battle (combat logic iteration)
./scripts/run_autobattle.sh --seed 1234 --freeze-timeout 10 --loop-threshold 20

# Full-fidelity test (primary end-to-end verification)
./scripts/run_autobattle.sh --full-fidelity --seed 42
```

- Auto-battle failures: `TIMEOUT_FREEZE` or `INFINITE_LOOP` — see [AGENTS-AUTOBATTLE-DEBUG.md](../AGENTS-AUTOBATTLE-DEBUG.md).
- **Iron rule**: never disable systems to make tests pass; fix the game code.
- Test class naming: `{SystemUnderTest}Tests`; method naming: `Method_Condition_ExpectedResult`.
- Parity allowlist for known gaps: `Data/Validation/parity_allowlist.json`.

---

## Common Gotchas

- **TorusMesh**: already ground-aligned in Godot. Do NOT add a 90° X-axis rotation to range/selection/target rings.
- **testhost interop**: `Godot.GD.Print/PrintErr` and `FileAccess`/`DirAccess` can crash `dotnet test`. Use `RuntimeSafety` helpers (falls back to `Console`/`System.IO`) in any data-layer code exercised by unit tests.
- **Targetless abilities** (`Self`, `All`, `None`): prime on hotbar click, execute on battlefield click — do not short-circuit this flow.
- **Deprecated docs**: check `AGENTS.md § Governance` for the banned documentation list before consulting any doc in `/docs`.
- **Dual HUD**: `CombatHUD` (legacy, in Arena/) and `HudController` (new, in UI/) coexist. New work should target `HudController`.
- **EffectPipeline size**: At ~3.3k lines, it uses property injection for ~15 optional services. When adding new service dependencies, follow the existing pattern of nullable property setters.
- **BG3StatusIntegration**: exists in both `Combat/Statuses/` and `Data/Statuses/` with different roles — data-layer conversion vs runtime integration.
- **PROJECT_STATUS.md**: Does not exist. Do not reference it. Use AGENTS.md as the governance doc.
