# QDND — Coding Standards

> **Authority:** This document is the law. All code contributions must conform.
> **Enforcement:** Code review + CI. No exceptions without documented rationale.

---

## 1. Naming Conventions

| Element | Convention | Example |
|---|---|---|
| Classes, structs, enums | PascalCase | `ActionExecutionService`, `BoostType` |
| Interfaces | `I` + PascalCase | `ICombatContext`, `IReactionResolver` |
| Public methods, properties | PascalCase | `TakeDamage()`, `CurrentHP` |
| Private fields | `_camelCase` | `_turnQueue`, `_activeBoosts` |
| Local variables, parameters | camelCase | `targetCombatant`, `damageResult` |
| Constants (class-level) | SCREAMING_SNAKE_CASE | `MAX_ROUNDS`, `DEFAULT_AC` |
| Constants (local) | camelCase | `const float moveSpeed = 5f;` |
| Enum members | PascalCase | `DamageType.Fire`, `CombatState.TurnStart` |
| Godot signals | PascalCase (matches C# event naming) | `[Signal] delegate void TurnEndedEventHandler()` |

**Never use:** Hungarian notation, `m_` prefix, `s_` prefix, abbreviations in public API.

---

## 2. Namespace Rules

**All code MUST use the `QDND.*` namespace hierarchy.**

```csharp
// CORRECT — block style (preferred for existing code)
namespace QDND.Combat.Actions
{
    public class ActionDefinition { }
}

// CORRECT — file-scoped style (acceptable for new files)
namespace QDND.Combat.Actions;
public class ActionDefinition { }

// WRONG — missing QDND prefix
namespace Tools;        // ← BANNED
namespace Combat;       // ← BANNED
```

**Namespace must match directory path:**

| Directory | Namespace |
|---|---|
| `Combat/Actions/` | `QDND.Combat.Actions` |
| `Combat/Actions/Effects/` | `QDND.Combat.Actions.Effects` |
| `Data/Parsers/` | `QDND.Data.Parsers` |
| `Tools/AutoBattler/` | `QDND.Tools.AutoBattler` |
| `Editor/` | `QDND.Editor` |
| `Tests/Unit/` | `QDND.Tests.Unit` |

---

## 3. File Organization

- **One primary class per file.** The filename must match the class name.
- **Small helper types** (enums, records, DTOs) used only by one class may live in the same file, below the primary class.
- **Never put 28 classes in one file.** If a file exceeds ~500 lines or contains more than 3 types, split it.
- **No backup files** (`.old`, `.old.1`, `.bak`) in the repository.
- **`.cs.uid` files** are auto-generated by Godot — do not manually create or delete them.

---

## 4. Dependency Injection & Service Location

**The pattern is constructor injection via `ICombatContext`.**

```csharp
// CORRECT
public class TurnLifecycleService
{
    private readonly TurnQueueService _turnQueue;
    private readonly StatusSystem _statusSystem;

    public TurnLifecycleService(TurnQueueService turnQueue, StatusSystem statusSystem)
    {
        _turnQueue = turnQueue;
        _statusSystem = statusSystem;
    }
}
```

**Do NOT:**
- Pull services from `CombatContext.Instance` inside service constructors
- Create static service locators
- Use `GetNode<T>()` to find services (that's for scene tree nodes only)

---

## 5. Event & Signal Policy

Three communication mechanisms exist. Use the correct one for each layer:

| Layer | Mechanism | When |
|---|---|---|
| **Service ↔ Service** | `event Action<T>` | All inter-service communication |
| **UI Model → UI Panel** | Godot `[Signal]` | Model changes that update visuals |
| **Presentation Bus** | `PresentationRequestBus` | Camera, VFX, SFX timing |

**Do NOT use `event EventHandler<T>`** — it is the older .NET pattern. Use `event Action<T>` for consistency.

```csharp
// CORRECT
public event Action<Combatant, int>? OnDamageDealt;

// WRONG — do not use EventHandler pattern
public event EventHandler<DamageEventArgs>? OnDamageDealt;
```

---

## 6. Error Handling

| Context | Pattern |
|---|---|
| **Invalid arguments** | `throw new ArgumentNullException(nameof(param))` |
| **Invalid state** | `throw new InvalidOperationException("message")` |
| **Godot runtime warnings** | `GD.PushWarning("message")` |
| **Godot runtime errors** | `GD.PushError("message")` |
| **Data layer (testhost-safe)** | Use `RuntimeSafety` helpers (falls back to `Console` in test host) |

**Do NOT use `GD.PrintErr()`** — use `GD.PushError()` instead (it integrates with the Godot error reporter).

**Do NOT silently swallow errors.** If a method returns null on failure, document why and log the reason.

---

## 7. Architecture Rules (from AGENTS.md — repeated here for completeness)

| Rule | Authority |
|---|---|
| Stats come from `CharacterSheet` / `CharacterResolver` only | No `CombatantStats` class |
| Passives use `PassiveRegistry` → `BoostApplicator` | ~~`PassiveRuleService`~~ is deleted |
| Conditions: `ConditionEffects.cs` is the **sole** mechanical authority | All 16 D&D conditions |
| Actions: `ActionRegistry` is the only action store | Fed by `ActionRegistryInitializer` |
| Equipment: 12-slot `EquipSlot` enum via `InventoryService` | ~~`EquipmentLoadout`~~ is deleted |
| Ability modifier: `Math.Floor((score - 10) / 2.0)` | In `CharacterResolver` |
| Save DC: `8 + proficiency + abilityModifier` | **Never hardcode a DC value** |

---

## 8. Godot-Specific Rules

- Godot node classes **must** be `public partial class`.
- `[Export]` properties use PascalCase (Godot convention).
- Scene files (`.tscn`) must reference C# scripts via `res://` paths.
- `#if TOOLS` guard all editor-only code.
- Never rotate `TorusMesh` indicators by 90° — they are already ground-aligned.
- Targetless abilities (`Self`, `All`, `None`) prime on hotbar click, execute on battlefield click.

---

## 9. Test Conventions

- Test classes: `{SystemUnderTest}Tests` (e.g., `StatusSystemTests`)
- Test methods: `MethodOrScenario_Condition_ExpectedResult` (e.g., `TakeDamage_WhenResistant_HalvesDamage`)
- Unit tests go in `Tests/Unit/`
- Integration tests go in `Tests/Integration/`
- Simulation tests go in `Tests/Simulation/`
- Performance benchmarks go in `Tests/Performance/`
- **No loose test files at the `Tests/` root** — put them in the correct subdirectory.
- Use `[Trait("Category", "...")]` to categorize, not file renaming (`.skip`).

---

## 10. Code Review Checklist

Before approving any change, verify:

- [ ] Namespace matches directory path and starts with `QDND.`
- [ ] No magic numbers for game rules (DCs, ranges, etc.)
- [ ] Events use `event Action<T>`, not `EventHandler<T>`
- [ ] Error handling uses the correct pattern for the layer
- [ ] No god-files created (>500 lines with multiple unrelated classes)
- [ ] All three build gates pass (`ci-build.sh`, `ci-test.sh`, `ci-godot-log-check.sh`)
- [ ] New systems have corresponding tests
- [ ] Documentation updated if architecture changed

---

*This document establishes the coding standards for all QDND development. Deviations require explicit approval documented in the PR description.*
