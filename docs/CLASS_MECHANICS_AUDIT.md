# Class Mechanics Audit ‚Äî Runtime Reality Check

> Generated by systematic code audit. For each mechanic: **does runtime C# code exist**, or is it **JSON-only wiring** through the generic pipeline?

## Architecture Summary

The combat system has a **generic data-driven pipeline**:

| Layer | File | What It Does |
|-------|------|-------------|
| Effect Pipeline | `Combat/Abilities/EffectPipeline.cs` | Executes abilities: validates costs, rolls attacks/saves, dispatches effects |
| Effects | `Combat/Abilities/Effects/Effect.cs` | 13 effect types: damage, heal, apply_status, remove_status, modify_resource, teleport, forced_move, spawn_surface, summon, spawn_object, interrupt, counter, grant_action |
| Rules Engine | `Combat/Rules/RulesEngine.cs` | Dice rolling, attack/save resolution, modifier stacks, advantage/disadvantage |
| Damage Pipeline | `Combat/Rules/DamagePipeline.cs` | 7-stage damage calc (base ‚Üí modifiers ‚Üí resist/vuln ‚Üí reductions ‚Üí floor ‚Üí layers ‚Üí HP) |
| Status System | `Combat/Statuses/StatusSystem.cs` | Data-driven statuses with modifiers, tick effects, trigger effects, blocked actions |
| Concentration | `Combat/Statuses/ConcentrationSystem.cs` | Tracks concentration spells, breaks on new cast |
| Reactions | `Combat/Reactions/ReactionSystem.cs` | Opportunity attacks, Shield spell, ability-triggered reactions |
| Resources | `Combat/Entities/CombatantResourcePool.cs` | Tracks spell slots, ki, rage charges, etc. with consume/refresh |

**Key insight**: Most "class mechanics" are JSON ability definitions that wire up generic effects. Only a handful have dedicated C# runtime code. A JSON definition saying `"type": "apply_status", "statusId": "raging"` **does work at runtime** through the generic pipeline ‚Äî but the *quality* of the implementation varies wildly from "faithful BG3" to "crude approximation."

---

## Rating System

| Rating | Meaning |
|--------|---------|
| ‚úÖ **WORKS** | Real runtime behavior, faithful or close to BG3 |
| ‚ö†Ô∏è **CRUDE** | Functions through generic pipeline but with wrong values, missing conditions, or missing half the mechanic |
| ‚ùå **MISSING** | No implementation at all ‚Äî JSON class data mentions it but no ability/status/code exists |
| üîß **JSON-ONLY** | Defined in JSON, works through generic pipeline, but specific edge-case logic not coded |

---

## 1. BARBARIAN

### Rage ‚Äî ‚ö†Ô∏è CRUDE (partially real C# code)
- **JSON ability** (`bg3_mechanics_abilities.json`): Costs bonus action + 1 rage_charge, applies `"raging"` status for 10 turns.
- **Status** (`bg3_mechanics_statuses.json`): `raging` = flat +2 damageDealt, advantage on skillCheck.
- **C# runtime code** (`Effect.cs:DealDamageEffect.ApplyConditionalDamageModifiers()`): Checks for `"raging"` status ‚Üí halves bludgeoning/slashing/piercing damage taken. **This is REAL runtime resistance.**
- **What's wrong**:
  - +2 damage is `flat to ALL damageDealt`, not melee-only as BG3 requires (Rage damage only applies to STR-based melee attacks).
  - No "Rage ends if you don't attack or take damage" tracking.
  - Damage bonus should scale with level (+2/+3/+4), currently hardcoded +2.

### Reckless Attack ‚Äî ‚ö†Ô∏è HALF-BROKEN
- **JSON ability**: Applies `"reckless"` status to self.
- **Status**: `reckless` = advantage on attackRoll.
- **MISSING**: Enemies should also get advantage against you until your next turn. The status only grants YOU advantage ‚Äî the penalty half is completely absent.

### Frenzy (Berserker) ‚Äî üîß JSON-ONLY (works)
- **JSON ability** (`frenzy`): Requires `"raging"` status, costs bonus action, deals 1d8+3 melee damage.
- Mechanically functions as a bonus-action melee attack. **Works** but the "exhaustion after rage ends" penalty is absent (not relevant in single-combat format).

### Bear Heart Rage (Wildheart) ‚Äî ‚úÖ WORKS
- **C# runtime code** (`Effect.cs:ApplyConditionalDamageModifiers()`): Checks for `"bear_heart_rage"` status ‚Üí halves ALL damage types EXCEPT psychic. Dedicated code path. **Faithful to BG3.**

### Danger Sense, Brutal Critical, Persistent Rage ‚Äî ‚ùå MISSING
- Class JSON defines these as features (descriptions only). No abilities, statuses, or runtime code.

---

## 2. FIGHTER

### Action Surge ‚Äî ‚úÖ WORKS
- **JSON ability**: Costs bonus action + 1 action_surge charge. Effect type: `"grant_action"` with `"grantType": "action"`, `"count": 1`.
- **C# runtime code** (`Effect.cs:GrantActionEffect.Execute()`): Calls `ActionBudget.GrantAdditionalAction(1)`. **Real runtime.** Correctly grants an additional action.

### Second Wind ‚Äî üîß JSON-ONLY (works, not scaled)
- **JSON ability**: Costs bonus action + 1 second_wind charge. Effect: `heal` with formula `"1d10+5"`.
- Goes through `HealEffect` ‚Üí `RulesEngine.RollHealing()`. **Works.** But the +5 should be +FighterLevel, not hardcoded.

### Extra Attack ‚Äî ‚ö†Ô∏è DATA-ONLY
- `ClassDefinition.cs` has `ExtraAttacks` property on `LevelProgression`. Class JSONs set `"extraAttacks": 1` at level 5.
- **No C# code found** that reads `ExtraAttacks` to grant multiple attacks per action. The data field exists but appears unused by the combat action system.

### Battle Master Maneuvers (Trip, Disarm, Riposte) ‚Äî ‚ùå MISSING
- Class JSON defines Battle Master subclass with `superiority_dice` resource and feature descriptions.
- **No maneuver abilities exist** in `bg3_mechanics_abilities.json`. No trip_attack, disarming_strike, or riposte abilities.
- Resource pool system DOES support `superiority_dice` (tested in `ResourceRefreshTests.cs`), but nothing consumes them.

### Champion (Improved Critical) ‚Äî ‚ùå MISSING
- Class JSON describes "Critical hits on 19 or 20." No runtime code modifies the critical threshold. `RulesEngine.RollAttack()` has critical threshold support via `criticalThreshold` modifier but no status/code sets it for Champion.

### Eldritch Knight / Arcane Archer ‚Äî ‚ùå MISSING
- Class JSON has descriptions only. No spellcasting integration or special abilities.

---

## 3. ROGUE

### Sneak Attack ‚Äî ‚úÖ WORKS (best implementation)
- **C# runtime code** (`Effect.cs:DealDamageEffect.Execute()`):
  - Checks `hasSneakAttackFeature` on the combatant.
  - Validates weapon has `finesse` or `ranged` tag.
  - Checks advantage OR ally within 1.5m of target.
  - Scales extra dice via `sneak_attack_dice` resource pool.
  - Rolls `Nd6` extra damage (N = sneak_attack_dice count).
- **This is the most faithful BG3 mechanic in the codebase.** Real conditional checks, proper scaling.

### Cunning Action (Dash/Disengage/Hide) ‚Äî üîß JSON-ONLY (works)
- **JSON abilities**: Three separate abilities (`cunning_action_dash`, `cunning_action_disengage`, `cunning_action_hide`), each costs bonus action.
  - Dash: applies `"dashing"` status (doubled movement).
  - Disengage: applies `"disengaged"` status (no opportunity attacks).
  - Hide: applies `"hidden"` status (advantage on next attack, untargetable).
- All go through generic ApplyStatus pipeline. **Works mechanically.**

### Uncanny Dodge ‚Äî ‚ö†Ô∏è DATA-ONLY
- Class JSON defines the feature at Rogue level 5. Appears in `reaction_test.json` scenario as reaction type `"uncanny_dodge"`.
- **No C# runtime code** for halving attack damage as a reaction. The reaction system infrastructure exists (ReactionSystem, ReactionPrompt) but no Uncanny Dodge handler is implemented.

### Evasion ‚Äî ‚ùå MISSING
- Class JSON describes it. **No runtime code.** Would need to hook into save resolution to convert half damage ‚Üí zero damage on DEX save success.

### Assassinate ‚Äî ‚ùå MISSING
- Class JSON describes "advantage on creatures that haven't taken a turn." No surprise/initiative-order checking code.

### Thief (Fast Hands, Second-Story Work) ‚Äî ‚ùå MISSING
- Descriptions only in class JSON.

---

## 4. MONK

### Ki Resource System ‚Äî ‚úÖ WORKS
- `ki_points` resource pool is set up in class JSON and consumed by abilities. `CombatantResourcePool` handles it.

### Flurry of Blows ‚Äî üîß JSON-ONLY (works)
- **JSON ability**: Costs bonus action + 1 ki_point. Two damage effects (1d4+3 each).
- Goes through generic `DealDamageEffect` twice. **Works as two bonus-action strikes.**

### Stunning Strike ‚Äî üîß JSON-ONLY (works)
- **JSON ability**: Costs 1 ki_point. On hit, target makes CON save (DC 13) or gets `"stunned"` status.
- **Status** `"stunned"`: advantage on attackRoll against target, blocks `action` and `bonus_action`, auto-fail STR/DEX saves.
- This is actually **well-implemented** through the generic system. The stunned status has proper modifiers.

### Step of the Wind ‚Äî üîß JSON-ONLY (works)
- **JSON ability**: Costs bonus action + 1 ki_point. Applies `"dashing"` and `"disengaged"` statuses.
- **Works** ‚Äî same as Cunning Action Dash+Disengage combined.

### Patient Defence ‚Äî üîß JSON-ONLY (works)
- **JSON ability**: Costs bonus action + 1 ki_point. Applies `"dodging"` status.
- **Status** `"dodging"`: +2 AC, advantage on savingThrow. **Crude** ‚Äî BG3 Dodge imposes disadvantage on attacks against you, not just +2 AC. But it works.

### Martial Arts (bonus unarmed), Deflect Missiles, Slow Fall, Stillness of Mind ‚Äî ‚ùå MISSING
- Class JSON describes these. No abilities or statuses exist.

### Open Hand Techniques, Shadow Step, Elemental Disciplines ‚Äî ‚ùå MISSING
- All subclass features are descriptions only.

---

## 5. CLERIC

### Channel Divinity Resource ‚Äî ‚úÖ WORKS
- `channel_divinity` resource pool exists, consumed by abilities, tested in `ResourceRefreshTests.cs`.

### Turn Undead ‚Äî ‚ö†Ô∏è CRUDE
- **JSON ability**: AoE (radius 9), WIS save (DC 13), applies `"frightened"` status on fail.
- `"frightened"` status: blocks movement, disadvantage on attackRoll and skillCheck.
- **MISSING**: No undead type check ‚Äî affects ALL enemies regardless of creature type. Also no "destroy undead at low CR" scaling.

### Preserve Life (Life Domain) ‚Äî üîß JSON-ONLY (works)
- **JSON ability**: AoE heal (radius 9), restores flat 10 HP to allies. Costs 1 channel_divinity.
- Goes through HealEffect. **Works** but should distribute pool of HP (5 √ó cleric level) rather than flat 10 to each ally.

### Guided Strike (War Domain) ‚Äî ‚úÖ WORKS
- **Status** `"guided_strike"`: flat +10 to attackRoll, duration 1 turn.
- Applied through ApplyStatusEffect. The RulesEngine modifier stack properly applies the +10. **Faithful to BG3** (BG3 grants +10 to one attack roll).

### Destructive Wrath (Tempest Domain) ‚Äî ‚ö†Ô∏è CRUDE
- **Status** `"destructive_wrath"`: flat +20 to damageDealt, duration 1 turn.
- **Should be**: Maximize thunder/lightning damage dice. A flat +20 is a crude approximation. No damage type check (applies to ALL damage types, not just thunder/lightning).

### Potent Spellcasting, Divine Intervention, Domain spells ‚Äî ‚ùå MISSING
- Class JSON mentions them. No runtime implementation.

---

## 6. PALADIN

### Divine Smite ‚Äî üîß JSON-ONLY (works, not scaled)
- **JSON abilities**: `divine_smite` (2d8 radiant, costs spell_slot_1) and `divine_smite_2` (3d8 radiant, costs spell_slot_2).
- Goes through DealDamage effect. **Works as basic extra radiant damage.** But:
  - No "extra d8 vs undead/fiend" bonus.
  - Not triggered on-hit ‚Äî it's a separate ability, not an automatic rider.
  - Only 2 tiers defined; BG3 has slot levels 1-4 for smite.

### Lay on Hands ‚Äî üîß JSON-ONLY (crude)
- **JSON ability**: Flat 20 HP heal with `lay_on_hands_pool: 1` resource cost.
- **Should be**: Variable-amount heal from a pool of 5 √ó Paladin level HP. Current version is just a fixed 20 HP heal.

### Aura of Protection ‚Äî ‚ö†Ô∏è CRUDE
- **Status** `"aura_of_protection"`: flat +3 to savingThrow.
- **Should be**: +CHA modifier (not hardcoded +3), affects all allies within 10ft (30ft at level 18). No proximity/aura check ‚Äî just applied as a static buff on self.

### Smite spells (Thunderous, Wrathful, etc.) ‚Äî ‚ùå MISSING
- Not in ability JSONs.

### Oath Features (Sacred Weapon, Vow of Enmity, etc.) ‚Äî ‚ùå MISSING
- Subclass JSONs have descriptions but zero linked abilities.

---

## 7. DRUID

### Wild Shape ‚Äî ‚ùå MISSING (resource exists, no transformation)
- Class JSON defines `wild_shape_charges: 2` resource and feature descriptions.
- **JSON ability** `wild_shape` exists in `bg3_mechanics_abilities.json` ‚Äî but it's just `symbiotic_entity` (Spores Druid) using `wild_shape: 1` as its resource cost. **No actual transformation mechanic.**
- No beast form stat replacement, no form selection, no HP override. This is the single biggest missing feature.

### Symbiotic Entity (Spores) ‚Äî ‚ö†Ô∏è CRUDE
- **JSON ability**: Costs bonus action + 1 wild_shape charge. Applies `"symbiotic_entity"` status.
- **Status**: flat +3 damageDealt.
- **Should be**: Grant 4 √ó druid level temp HP, deal 1d6 extra necrotic on melee hits. Current version is just a flat damage buff.

### Natural Recovery, Land Circle spells, Moon Combat Wild Shape ‚Äî ‚ùå MISSING
- Descriptions only.

---

## 8. RANGER

### Favored Enemy, Natural Explorer ‚Äî ‚ùå MISSING
- Class JSON descriptions only.

### Hunter's Mark ‚Äî appears as Hex variant (see Warlock's Hex)
- No dedicated ranger `hunters_mark` ability found in the JSON.

### Hunter subclass (Colossus Slayer, Horde Breaker) ‚Äî ‚ùå MISSING
### Beast Master (Animal Companion) ‚Äî ‚ùå MISSING
### Gloom Stalker (Dread Ambusher) ‚Äî ‚ùå MISSING

**Ranger is the least implemented class.** The class JSON has full level tables and subclass descriptions but zero operational abilities.

---

## 9. SORCERER

### Sorcery Points Resource ‚Äî ‚úÖ WORKS
- `sorcery_points` resource pool in class JSON, consumed by metamagic abilities.

### Font of Magic (Create Sorcery Points) ‚Äî üîß JSON-ONLY (works)
- **JSON ability** `create_sorcery_points`: Consumes 1 spell_slot_1, grants 2 sorcery_points via `modify_resource` effect.
- Goes through `ModifyResourceEffect`. **Works** for one specific conversion (level 1 slot ‚Üí 2 points). BG3 has bidirectional conversion at multiple levels.

### Metamagic ‚Äî ‚ö†Ô∏è CRUDE (manual ability duplication)
- **Not a generic system.** Instead, specific metamagicked spells are manually created:
  - `quickened_spell_fire_bolt`: Fire Bolt as bonus action, costs 2 sorcery_points.
  - `twinned_spell_hold_person`: Hold Person with `maxTargets: 2`, costs 2 sorcery_points.
- **Should be**: A metamagic layer that can apply Quicken/Twin/Subtle/etc. to ANY eligible spell.
- Current approach requires creating a separate JSON ability for every metamagic+spell combination. Not scalable.

### Draconic Bloodline (extra HP, affinity damage) ‚Äî ‚ùå MISSING
### Wild Magic Surge ‚Äî ‚ùå MISSING
### Storm/Shadow subclass features ‚Äî ‚ùå MISSING

---

## 10. WARLOCK

### Pact Magic (short-rest spell slots) ‚Äî ‚ö†Ô∏è DATA-ONLY
- Class JSON defines spell_slot_pact_1, spell_slot_pact_2, etc. Resource system can track them.
- **No runtime code** distinguishes pact slots from regular slots for short-rest recovery purposes. The `ResourceRefreshTests` show generic refresh but no pact-specific short rest logic.

### Eldritch Blast ‚Äî üîß JSON-ONLY (works, not scalable)
- **JSON abilities**: Two versions: `eldritch_blast` (1 beam, 1d10+4) and `eldritch_blast_2` (2 beams, each 1d10+4).
- Each goes through `DealDamageEffect`. **Works** but:
  - Beam scaling (1/2/3/4 beams at levels 1/5/11/17) requires manual ability creation per tier.
  - Agonizing Blast (+CHA) is baked into the formula as +4, not dynamically computed.

### Hex ‚Äî üîß JSON-ONLY (works)
- **JSON ability**: Applies `"hexed"` status with concentration.
- **Status** `"hexed"`: -2 savingThrow, tick damage of 3 necrotic/turn.
- **Should be**: +1d6 necrotic on each hit (not per-turn tick), disadvantage on one chosen ability check. Current implementation is a per-turn DoT instead of on-hit rider.

### Pact Boon (Blade/Tome/Chain) ‚Äî ‚ùå MISSING
### Invocations (beyond Agonizing Blast) ‚Äî ‚ùå MISSING
### Patron features ‚Äî ‚ùå MISSING

---

## 11. BARD

### Bardic Inspiration ‚Äî ‚ö†Ô∏è CRUDE
- **JSON ability**: Costs bonus action + 1 bardic_inspiration charge. Applies `"inspired"` status for 10 turns.
- **Status** `"inspired"`: flat +2 attackRoll, flat +2 savingThrow.
- **Should be**: Add a Bardic Inspiration die (d6 at 1st, d8 at 5th, d10 at 10th, d12 at 15th) to ONE ability check, attack, or save. Current flat +2 is a pale shadow.

### Cutting Words (Lore) ‚Äî ‚ö†Ô∏è CRUDE
- **JSON ability**: Reaction (`usesReaction: true`), costs 1 bardic_inspiration. Applies `"cutting_words_debuff"`.
- **Status**: flat -3 attackRoll, flat -3 savingThrow.
- **Should be**: Subtract a Bardic Inspiration die from the target's roll. Flat -3 is an approximation.
- The **reaction trigger** is real (goes through ReactionSystem).

### Blade Flourish (Swords) ‚Äî ‚ö†Ô∏è CRUDE
- **JSON ability**: Melee attack (1d8+3) + applies `"blade_flourish"` status.
- **Status**: +2 AC, +3 damage.
- **Should be**: Add Bardic Inspiration die to damage AND choose a flourish effect (Defensive/Slashing/Mobile). Current version is a generic buff.

### Jack of All Trades, Song of Rest, Magical Secrets ‚Äî ‚ùå MISSING
### College features beyond above ‚Äî ‚ùå MISSING

---

## Cross-Cutting Systems Audit

### Concentration System ‚Äî ‚úÖ WORKS
- `ConcentrationSystem.cs` tracks one concentration spell per caster. New concentration spell breaks the old one. Integrated into `EffectPipeline` when `RequiresConcentration` is set on an ability.

### Reaction System ‚Äî ‚úÖ WORKS
- `ReactionSystem.cs` handles trigger-based reactions. Opportunity attacks (`EnemyLeavesReach`), Shield spell (`YouTakeDamage`), and custom per-ability reactions are registered and fire at runtime.

### Resource Pool System ‚Äî ‚úÖ WORKS
- `CombatantResourcePool.cs` handles all class resources (rage, ki, spell slots, channel divinity, sorcery points, bardic inspiration, superiority dice). Supports consume, refresh, set-max, modify-current. Tested.

### Modifier Stack System ‚Äî ‚úÖ WORKS
- `RulesEngine` maintains modifier stacks (attackRoll, damageDealt, damageTaken, armorClass, savingThrow, movementSpeed, skillCheck). Statuses register modifiers when applied and remove them when status expires. Supports flat, percentage, and advantage/disadvantage types.

### Extra Attack ‚Äî ‚ö†Ô∏è DATA-ONLY
- `ClassDefinition.LevelProgression.ExtraAttacks` field exists and is populated in class JSONs. **No code reads it to allow multiple attacks per action.**

---

## Summary Scorecard

| Class | Mechanics Defined | Actually Work | Crude/Half | Missing | Best Mechanic | Worst Gap |
|-------|:---:|:---:|:---:|:---:|---|---|
| **Barbarian** | 5 | 1 | 2 | 2 | Bear Heart Rage resistance | Reckless (no penalty half) |
| **Fighter** | 6 | 1 | 1 | 4 | Action Surge | Battle Master maneuvers (zero) |
| **Rogue** | 6 | 1 | 1 | 4 | Sneak Attack | Evasion, Uncanny Dodge |
| **Monk** | 8 | 1 | 4 | 3 | Ki system + Stunning Strike | Open Hand, subclass features |
| **Cleric** | 6 | 2 | 1 | 3 | Guided Strike | Turn Undead (no type check) |
| **Paladin** | 6 | 0 | 3 | 3 | ‚Äî | Aura of Protection (hardcoded +3) |
| **Druid** | 5 | 0 | 1 | 4 | ‚Äî | Wild Shape (completely absent) |
| **Ranger** | 5 | 0 | 0 | 5 | ‚Äî | Everything (zero abilities) |
| **Sorcerer** | 5 | 1 | 1 | 3 | Sorcery Points resource | Metamagic (not generic) |
| **Warlock** | 5 | 0 | 3 | 2 | ‚Äî | Hex (DoT instead of on-hit) |
| **Bard** | 5 | 0 | 3 | 2 | ‚Äî | Bardic Inspiration (flat +2 not dice) |

### Mechanics with REAL dedicated C# code (3 total):
1. **Sneak Attack** ‚Äî `Effect.cs:DealDamageEffect` ‚Äî conditional checks, scaling dice
2. **Rage/Bear Heart resistance** ‚Äî `Effect.cs:ApplyConditionalDamageModifiers()` ‚Äî damage type filtering and halving
3. **Action Surge** ‚Äî `Effect.cs:GrantActionEffect` ‚Äî grants action via ActionBudget

### Everything else goes through the generic pipeline with varying fidelity.

---

## Priority Fixes (highest impact)

1. **Extra Attack runtime**: The data field exists. Wire `ExtraAttacks` into the action/attack system so Fighters, Paladins, Rangers, Monks, and Barbarians can attack twice at level 5+.
2. **Reckless Attack penalty**: Add "enemies have advantage against you" when reckless status is active.
3. **Wild Shape**: The single biggest missing system. Needs stat replacement, form selection, separate HP pool.
4. **Battle Master maneuvers**: Create abilities for Trip Attack, Disarming Strike, Riposte consuming superiority_dice. 
5. **Bardic Inspiration dice**: Replace flat +2 with an actual die roll (d6/d8/d10/d12 based on bard level).
6. **Hex on-hit damage**: Change from tick DoT to on-hit rider (extra 1d6 necrotic per attack).
7. **Ranger abilities**: Implement at least Hunter's Mark, Colossus Slayer, and Dread Ambusher.
8. **Metamagic system**: Build a generic metamagic layer instead of duplicating abilities.
9. **Aura of Protection**: Read CHA modifier instead of hardcoded +3; add proximity check for allies.
10. **Destructive Wrath**: Implement actual "maximize thunder/lightning dice" instead of flat +20.
